---
import BaseLayout from '../layouts/BaseLayout.astro';
import {
  loadAllHarnesses,
  getFieldSafe,
  getSections,
  makeFieldAnchor,
} from '../data/loader.ts';

const harnesses = loadAllHarnesses();

const harnessColumns = harnesses.map((h) => {
  const id = getFieldSafe(h, 'id').value;
  const name = getFieldSafe(h, 'name').value;
  return {
    id: String(id ?? ''),
    name: String(name ?? id ?? 'Unknown'),
  };
});

const matrixSections = [];
const sectionLookup = new Map();

for (let harnessIndex = 0; harnessIndex < harnesses.length; harnessIndex += 1) {
  const harness = harnesses[harnessIndex];
  const sections = getSections(harness);

  for (const section of sections) {
    let matrixSection = sectionLookup.get(section.key);
    if (!matrixSection) {
      matrixSection = {
        key: section.key,
        name: section.name,
        rows: [],
        rowLookup: new Map(),
      };
      sectionLookup.set(section.key, matrixSection);
      matrixSections.push(matrixSection);
    }

    for (const field of section.fields) {
      let row = matrixSection.rowLookup.get(field.key);
      if (!row) {
        row = {
          key: field.key,
          label: field.label,
          cells: Array(harnesses.length).fill(null),
        };
        matrixSection.rowLookup.set(field.key, row);
        matrixSection.rows.push(row);
      }
      row.cells[harnessIndex] = field.field;
    }
  }
}

function clip(input: string, max = 200): string {
  if (input.length <= max) return input;
  return `${input.slice(0, max - 1)}…`;
}

function summarizeValue(value: any): string {
  if (value == null) return '—';

  if (Array.isArray(value)) {
    if (value.length === 0) return '—';

    const primitiveArray = value.every(
      (item) => ['string', 'number', 'boolean'].includes(typeof item),
    );
    if (primitiveArray) {
      return String(value.join(', '));
    }

    const modeArray = value.every(
      (item) => item && typeof item === 'object' && 'mode' in item,
    );
    if (modeArray) {
      return value
        .map((item) =>
          item.detail ? `${String(item.mode)}: ${String(item.detail)}` : String(item.mode),
        )
        .join('; ');
    }

    return value.map((item) => summarizeValue(item)).join('; ');
  }

  if (typeof value === 'object') {
    const entries = Object.entries(value);
    if (entries.length === 0) return '—';
    return entries
      .slice(0, 4)
      .map(([k, v]) => `${k}=${String(v)}`)
      .join(', ');
  }

  return String(value);
}

function cellText(field: any): string {
  if (!field || typeof field !== 'object') return '—';
  return clip(summarizeValue(field.value), 220);
}
---

<BaseLayout title="" description="Side-by-side comparison of AI coding agent harnesses — architecture, capabilities, and reliability at a glance.">
  <section id="matrix">
    <div class="section-header fade-in-up stagger-1">
      <h2>Agent Harness Comparison</h2>
    </div>

    <p class="matrix-note muted">
      A side-by-side breakdown of how each agent harness is built, what it can do, and where it falls short.
      Click any harness column to see full evidence and citations.
    </p>

    <!-- Confidence legend -->
    <div class="confidence-legend fade-in-up stagger-2">
      <span class="confidence-legend__label">Confidence levels</span>
      <span class="badge badge--high">high</span> Confirmed in source
      <span class="confidence-legend__sep">·</span>
      <span class="badge badge--medium">medium</span> Inferred from patterns
      <span class="confidence-legend__sep">·</span>
      <span class="badge badge--low">low</span> Best guess
    </div>

    <!-- Section Jump Nav -->
    <nav class="section-jump fade-in-up stagger-2" aria-label="Jump to section">
      <span class="section-jump__label">Sections</span>
      <div class="section-jump__track">
        {matrixSections.map((section, i) => (
          <a
            href={`#section-${section.key}`}
            class="section-jump__pill"
            style={`animation-delay: ${120 + i * 40}ms`}
          >
            <span class="section-jump__index">{String(i + 1).padStart(2, '0')}</span>
            {section.name}
          </a>
        ))}
      </div>
    </nav>

    <div class="matrix-home-wrap fade-in-up stagger-3">
      <table class="matrix-home-table">
        <thead>
          <tr>
            <th class="top-left">Information Field</th>
            {harnessColumns.map((col) => (
              <th>
                <a href={`/h/${col.id}`} class="agent-head-link">
                  {col.name}
                </a>
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {matrixSections.map((section) => (
            <>
              <tr class="section-row" id={`section-${section.key}`}>
                <th colspan={harnessColumns.length + 1}>
                  {section.name}
                </th>
              </tr>
              {section.rows.map((row) => (
                <tr>
                  <th class="field-col">
                    <span class="field-label">{row.label}</span>
                    <span class="field-key mono muted">{row.key}</span>
                  </th>
                  {row.cells.map((cell, cellIndex) => (
                    <td>
                      {harnessColumns[cellIndex]?.id ? (
                        <a
                          class="cell-link"
                          href={`/h/${harnessColumns[cellIndex].id}#${makeFieldAnchor(section.key, row.key)}`}
                        >
                          <p class="cell-value">{cellText(cell)}</p>
                          {cell?.confidence && (
                            <span class={`badge badge--${cell.confidence}`}>{cell.confidence}</span>
                          )}
                        </a>
                      ) : (
                        <p class="cell-value">{cellText(cell)}</p>
                      )}
                    </td>
                  ))}
                </tr>
              ))}
            </>
          ))}
        </tbody>
      </table>
    </div>
  </section>

  <!-- Back to Top -->
  <button class="back-to-top" id="backToTop" aria-label="Back to top" title="Back to top">
    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" aria-hidden="true">
      <path d="M9 14V4M9 4L4.5 8.5M9 4L13.5 8.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <script>
    // Measure nav height and set CSS variable for sticky thead offset
    const navEl = document.querySelector('nav');
    if (navEl) {
      const h = navEl.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--nav-h', `${h}px`);
    }

    const btn = document.getElementById('backToTop');
    const jumpNav = document.querySelector('.section-jump');
    let ticking = false;

    function onScroll() {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const show = window.scrollY > 600;
          btn?.classList.toggle('visible', show);

          // Highlight active section in jump nav
          const sections = document.querySelectorAll('.section-row[id]');
          let activeKey = '';
          for (const sec of sections) {
            if (sec.getBoundingClientRect().top <= 160) {
              activeKey = sec.id;
            }
          }
          let activePill: Element | null = null;
          document.querySelectorAll('.section-jump__pill').forEach((pill) => {
            const href = pill.getAttribute('href');
            const isActive = href === `#${activeKey}`;
            pill.classList.toggle('active', isActive);
            if (isActive) activePill = pill;
          });

          // Scroll the jump nav so the active pill is visible
          if (activePill && jumpNav) {
            const nav = jumpNav as HTMLElement;
            const pill = activePill as HTMLElement;
            const pillLeft = pill.offsetLeft;
            const pillRight = pillLeft + pill.offsetWidth;
            const navScroll = nav.scrollLeft;
            const navWidth = nav.clientWidth;

            if (pillLeft < navScroll + 120) {
              nav.scrollTo({ left: Math.max(0, pillLeft - 120), behavior: 'smooth' });
            } else if (pillRight > navScroll + navWidth - 40) {
              nav.scrollTo({ left: pillRight - navWidth + 40, behavior: 'smooth' });
            }
          }

          ticking = false;
        });
        ticking = true;
      }
    }

    window.addEventListener('scroll', onScroll, { passive: true });

    btn?.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>
</BaseLayout>

<style>
  .matrix-note {
    margin-bottom: var(--sp-4);
    font-size: var(--fs-sm);
  }

  .matrix-home-wrap {
    border: 1px solid var(--c-border);
    border-radius: var(--r-lg);
    background: linear-gradient(
      180deg,
      rgba(24, 26, 33, 0.55) 0%,
      rgba(17, 19, 24, 0.65) 100%
    );
  }

  .matrix-home-table {
    width: 100%;
    min-width: 980px;
    border-collapse: separate;
    border-spacing: 0;
  }

  .matrix-home-table th,
  .matrix-home-table td {
    padding: var(--sp-3) var(--sp-4);
    border-bottom: 1px solid var(--c-border-subtle);
    vertical-align: top;
  }

  .matrix-home-table thead th {
    position: sticky;
    top: var(--nav-h, 2.8rem);
    z-index: 4;
    background: var(--c-surface-raise);
    border-bottom: 1px solid var(--c-border);
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: var(--fs-xs);
    color: var(--c-text-muted);
    white-space: nowrap;
  }

  .matrix-home-table .top-left {
    left: 0;
    z-index: 5;
  }

  .agent-head-link {
    color: var(--c-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .section-row th {
    background: rgba(45, 212, 191, 0.08);
    color: var(--c-text-heading);
    font-size: var(--fs-xs);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-family: var(--font-mono);
    border-bottom: 1px solid var(--c-border);
  }

  .field-col {
    position: sticky;
    left: 0;
    z-index: 3;
    width: 20rem;
    min-width: 20rem;
    background: var(--c-surface);
    border-right: 1px solid var(--c-border);
  }

  .field-label {
    display: block;
    color: var(--c-text-heading);
    font-size: var(--fs-sm);
    margin-bottom: var(--sp-1);
  }

  .field-key {
    display: block;
    font-size: var(--fs-sm);
    word-break: break-word;
  }

  .cell-value {
    color: var(--c-text);
    font-size: var(--fs-sm);
    line-height: 1.5;
    margin-bottom: var(--sp-2);
    white-space: normal;
    word-break: break-word;
  }

  .cell-link {
    display: block;
    color: inherit;
  }

  .cell-link:hover .cell-value {
    color: var(--c-text-heading);
  }

  .matrix-home-table tbody tr:hover td,
  .matrix-home-table tbody tr:hover .field-col {
    background: rgba(45, 212, 191, 0.06);
  }

  /* --- Row hover accent bar --- */
  .matrix-home-table tbody tr {
    position: relative;
  }

  .matrix-home-table tbody tr:not(.section-row) td:first-child,
  .matrix-home-table tbody tr:not(.section-row) .field-col {
    position: relative;
  }

  .matrix-home-table tbody tr:not(.section-row) .field-col::before {
    content: "";
    position: absolute;
    left: 0;
    top: 4px;
    bottom: 4px;
    width: 2px;
    background: var(--c-accent);
    border-radius: 1px;
    opacity: 0;
    transform: scaleY(0.4);
    transition: opacity 180ms ease, transform 180ms ease;
  }

  .matrix-home-table tbody tr:not(.section-row):hover .field-col::before {
    opacity: 1;
    transform: scaleY(1);
  }

  .matrix-home-table tbody tr:not(.section-row):hover .field-label {
    color: var(--c-accent);
    transition: color 180ms ease;
  }

  /* --- Section Jump Nav --- */
  .section-jump {
    display: flex;
    align-items: center;
    gap: var(--sp-3);
    padding: var(--sp-3) 0;
    margin-bottom: var(--sp-4);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    border-bottom: 1px solid var(--c-border);
  }

  .section-jump::-webkit-scrollbar {
    display: none;
  }

  .section-jump__label {
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    color: var(--c-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    white-space: nowrap;
    flex-shrink: 0;
    padding-right: var(--sp-2);
    border-right: 1px solid var(--c-border);
  }

  .section-jump__track {
    display: flex;
    gap: var(--sp-2);
    flex-shrink: 0;
  }

  .section-jump__pill {
    display: inline-flex;
    align-items: center;
    gap: var(--sp-2);
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    color: var(--c-text-muted);
    padding: var(--sp-1) var(--sp-3);
    border: 1px solid var(--c-border);
    border-radius: var(--r-sm);
    white-space: nowrap;
    transition: color 180ms ease, border-color 180ms ease, background 180ms ease, box-shadow 180ms ease;
    animation: fadeInUp 400ms ease both;
  }

  .section-jump__pill:hover {
    color: var(--c-text-heading);
    border-color: var(--c-text-muted);
    background: var(--c-surface-raise);
  }

  .section-jump__pill.active {
    color: var(--c-accent);
    border-color: var(--c-accent-dim);
    background: var(--c-accent-bg);
    box-shadow: 0 0 8px rgba(45, 212, 191, 0.1);
  }

  .section-jump__index {
    color: var(--c-accent-dim);
    font-size: 0.625rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    opacity: 0.7;
    transition: opacity 180ms ease;
  }

  .section-jump__pill:hover .section-jump__index,
  .section-jump__pill.active .section-jump__index {
    opacity: 1;
  }

  /* --- Back to Top --- */
  .back-to-top {
    position: fixed;
    bottom: var(--sp-8);
    right: var(--sp-8);
    z-index: 90;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    padding: 0;
    background: var(--c-surface-raise);
    border: 1px solid var(--c-border);
    border-radius: 50%;
    color: var(--c-text-muted);
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transform: translateY(12px);
    transition: opacity 280ms ease, transform 280ms ease, color 150ms ease, border-color 150ms ease, box-shadow 150ms ease;
    backdrop-filter: blur(6px);
  }

  .back-to-top.visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  .back-to-top:hover {
    color: var(--c-accent);
    border-color: var(--c-accent-dim);
    box-shadow: 0 0 12px rgba(45, 212, 191, 0.15);
  }

  .back-to-top:active {
    transform: translateY(-2px);
  }



  /* --- Confidence Legend --- */
  .confidence-legend {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--sp-2);
    font-family: var(--font-mono);
    font-size: var(--fs-xs);
    color: var(--c-text-muted);
    padding: var(--sp-3) var(--sp-4);
    margin-bottom: var(--sp-4);
    background: var(--c-surface);
    border: 1px solid var(--c-border-subtle);
    border-radius: var(--r-md);
  }

  .confidence-legend__label {
    font-weight: 600;
    color: var(--c-text-heading);
    margin-right: var(--sp-2);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .confidence-legend__sep {
    color: var(--c-border);
    margin: 0 var(--sp-1);
  }

  /* --- Mobile --- */
  @media (max-width: 768px) {
    .matrix-home-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-left: calc(-1 * var(--sp-4));
      margin-right: calc(-1 * var(--sp-4));
      border-radius: 0;
      border-left: none;
      border-right: none;
    }

    .matrix-home-table {
      min-width: 700px;
    }

    .field-col {
      width: 12rem;
      min-width: 12rem;
    }

    .section-jump {
      margin-left: calc(-1 * var(--sp-4));
      margin-right: calc(-1 * var(--sp-4));
      padding-left: var(--sp-4);
      padding-right: var(--sp-4);
    }

    .section-jump__label {
      display: none;
    }

    .confidence-legend {
      font-size: 0.625rem;
      gap: var(--sp-1);
      padding: var(--sp-2) var(--sp-3);
    }

    .back-to-top {
      bottom: var(--sp-4);
      right: var(--sp-4);
    }
  }

  @media (max-width: 480px) {
    .matrix-home-wrap {
      margin-left: calc(-1 * var(--sp-3));
      margin-right: calc(-1 * var(--sp-3));
    }

    .section-jump {
      margin-left: calc(-1 * var(--sp-3));
      margin-right: calc(-1 * var(--sp-3));
      padding-left: var(--sp-3);
      padding-right: var(--sp-3);
    }
  }
</style>
