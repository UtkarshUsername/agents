---
import BaseLayout from '../layouts/BaseLayout.astro';
import {
  loadAllHarnesses,
  getFieldSafe,
  getSections,
  makeFieldAnchor,
} from '../data/loader.ts';

const harnesses = loadAllHarnesses();

const harnessColumns = harnesses.map((h) => {
  const id = getFieldSafe(h, 'id').value;
  const name = getFieldSafe(h, 'name').value;
  return {
    id: String(id ?? ''),
    name: String(name ?? id ?? 'Unknown'),
  };
});

const matrixSections = [];
const sectionLookup = new Map();

for (let harnessIndex = 0; harnessIndex < harnesses.length; harnessIndex += 1) {
  const harness = harnesses[harnessIndex];
  const sections = getSections(harness);

  for (const section of sections) {
    let matrixSection = sectionLookup.get(section.key);
    if (!matrixSection) {
      matrixSection = {
        key: section.key,
        name: section.name,
        rows: [],
        rowLookup: new Map(),
      };
      sectionLookup.set(section.key, matrixSection);
      matrixSections.push(matrixSection);
    }

    for (const field of section.fields) {
      let row = matrixSection.rowLookup.get(field.key);
      if (!row) {
        row = {
          key: field.key,
          label: field.label,
          cells: Array(harnesses.length).fill(null),
        };
        matrixSection.rowLookup.set(field.key, row);
        matrixSection.rows.push(row);
      }
      row.cells[harnessIndex] = field.field;
    }
  }
}

function clip(input: string, max = 200): string {
  if (input.length <= max) return input;
  return `${input.slice(0, max - 1)}…`;
}

function summarizeValue(value: any): string {
  if (value == null) return '—';

  if (Array.isArray(value)) {
    if (value.length === 0) return '—';

    const primitiveArray = value.every(
      (item) => ['string', 'number', 'boolean'].includes(typeof item),
    );
    if (primitiveArray) {
      return String(value.join(', '));
    }

    const modeArray = value.every(
      (item) => item && typeof item === 'object' && 'mode' in item,
    );
    if (modeArray) {
      return value
        .map((item) =>
          item.detail ? `${String(item.mode)}: ${String(item.detail)}` : String(item.mode),
        )
        .join('; ');
    }

    return value.map((item) => summarizeValue(item)).join('; ');
  }

  if (typeof value === 'object') {
    const entries = Object.entries(value);
    if (entries.length === 0) return '—';
    return entries
      .slice(0, 4)
      .map(([k, v]) => `${k}=${String(v)}`)
      .join(', ');
  }

  return String(value);
}

function cellText(field: any): string {
  if (!field || typeof field !== 'object') return '—';
  return clip(summarizeValue(field.value), 220);
}
---

<BaseLayout title="Harness Matrix" description="Under-the-hood comparison matrix of agent harness behavior, architecture, and reliability.">
  <section id="matrix">
    <div class="section-header fade-in-up stagger-1">
      <h2>Under-The-Hood Matrix</h2>
    </div>

    <p class="matrix-note muted">
      Rows are capability/behavior fields. Columns are harnesses. For full evidence and raw citations,
      open a harness detail page from the column header.
    </p>

    <div class="matrix-home-wrap fade-in-up stagger-2">
      <table class="matrix-home-table">
        <thead>
          <tr>
            <th class="top-left">Information Field</th>
            {harnessColumns.map((col) => (
              <th>
                <a href={`/h/${col.id}`} class="agent-head-link">
                  {col.name}
                </a>
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {matrixSections.map((section) => (
            <>
              <tr class="section-row">
                <th colspan={harnessColumns.length + 1}>
                  {section.name}
                </th>
              </tr>
              {section.rows.map((row) => (
                <tr>
                  <th class="field-col">
                    <span class="field-label">{row.label}</span>
                    <span class="field-key mono muted">{row.key}</span>
                  </th>
                  {row.cells.map((cell, cellIndex) => (
                    <td>
                      {harnessColumns[cellIndex]?.id ? (
                        <a
                          class="cell-link"
                          href={`/h/${harnessColumns[cellIndex].id}#${makeFieldAnchor(section.key, row.key)}`}
                        >
                          <p class="cell-value">{cellText(cell)}</p>
                          {cell?.confidence && (
                            <span class={`badge badge--${cell.confidence}`}>{cell.confidence}</span>
                          )}
                        </a>
                      ) : (
                        <p class="cell-value">{cellText(cell)}</p>
                      )}
                    </td>
                  ))}
                </tr>
              ))}
            </>
          ))}
        </tbody>
      </table>
    </div>
  </section>
</BaseLayout>

<style>
  .matrix-note {
    margin-bottom: var(--sp-4);
    font-size: var(--fs-sm);
  }

  .matrix-home-wrap {
    overflow-x: auto;
    border: 1px solid var(--c-border);
    border-radius: var(--r-lg);
    background: linear-gradient(
      180deg,
      rgba(24, 26, 33, 0.55) 0%,
      rgba(17, 19, 24, 0.65) 100%
    );
  }

  .matrix-home-table {
    width: 100%;
    min-width: 980px;
    border-collapse: separate;
    border-spacing: 0;
  }

  .matrix-home-table th,
  .matrix-home-table td {
    padding: var(--sp-3) var(--sp-4);
    border-bottom: 1px solid var(--c-border-subtle);
    vertical-align: top;
  }

  .matrix-home-table thead th {
    position: sticky;
    top: 0;
    z-index: 4;
    background: var(--c-surface-raise);
    border-bottom: 1px solid var(--c-border);
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: var(--fs-xs);
    color: var(--c-text-muted);
    white-space: nowrap;
  }

  .matrix-home-table .top-left {
    left: 0;
    z-index: 5;
  }

  .agent-head-link {
    color: var(--c-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .section-row th {
    background: rgba(45, 212, 191, 0.08);
    color: var(--c-text-heading);
    font-size: var(--fs-xs);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-family: var(--font-mono);
    border-bottom: 1px solid var(--c-border);
  }

  .field-col {
    position: sticky;
    left: 0;
    z-index: 3;
    width: 20rem;
    min-width: 20rem;
    background: var(--c-surface);
    border-right: 1px solid var(--c-border);
  }

  .field-label {
    display: block;
    color: var(--c-text-heading);
    font-size: var(--fs-sm);
    margin-bottom: var(--sp-1);
  }

  .field-key {
    display: block;
    font-size: var(--fs-sm);
    word-break: break-word;
  }

  .cell-value {
    color: var(--c-text);
    font-size: var(--fs-sm);
    line-height: 1.5;
    margin-bottom: var(--sp-2);
    white-space: normal;
    word-break: break-word;
  }

  .cell-link {
    display: block;
    color: inherit;
  }

  .cell-link:hover .cell-value {
    color: var(--c-text-heading);
  }

  .matrix-home-table tbody tr:hover td,
  .matrix-home-table tbody tr:hover .field-col {
    background: rgba(45, 212, 191, 0.06);
  }
</style>
